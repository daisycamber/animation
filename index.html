<style>
* {font-family: sans-serif;}
</style>
<progress id="progress" value="0" max="600" min="0" style="width: 300px"></progress>
<br>
<canvas id="canvas" width="150" height="150"></canvas>
<video id="awesome" width="150" height="150" controls autoplay loop></video>
<br>
Status: <span id="status">Idle</span>
<a style="display:none" id="download" download="clock.webm">Download WebM</a>

<script src="whammy.js"></script>
<script>
// use requestanimation frame, woo!
(function() {
  var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
  window.requestAnimationFrame = requestAnimationFrame;
})();

//stolen wholesale off mozilla's wiki
function animate(frame){
	var ctx = document.getElementById('canvas').getContext('2d');
  const image = new Image(60, 45); // Using optional size for image
  image.src = "test.png"
  image.crossOrigin = "Anonymous";
  ctx.drawImage(image,10,10,100,100);
	ctx.save();
	return ctx;
}

// the actual demo code, yaaay
var last_time = +new Date;
var video = new Whammy.Video(60);
var progress = document.getElementById('progress');

function nextFrame(){
	progress.value++;
	var context = animate(progress.value);

	video.add(context);
	if(progress.value / progress.max < 1){
		requestAnimationFrame(nextFrame);
		document.getElementById('status').innerHTML = "Drawing Frames";
	}else{
		document.getElementById('status').innerHTML = "Compiling Video";
		requestAnimationFrame(finalizeVideo); // well, should probably use settimeout instead
	}

}

function finalizeVideo(){
	var start_time = +new Date;
	video.compile(false, function(output){

		var end_time = +new Date;
		var url = webkitURL.createObjectURL(output);

		document.getElementById('awesome').src = url; //toString converts it to a URL via Object URLs, falling back to DataURL
		document.getElementById('download').style.display = '';
		document.getElementById('download').href = url;
		document.getElementById('status').innerHTML = "Compiled Video in " + (end_time - start_time) + "ms, file size: " + Math.ceil(output.size / 1024) + "KB";

	});
}

nextFrame();
</script>
